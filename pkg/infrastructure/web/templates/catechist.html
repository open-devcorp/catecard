{{ define "content" }}
<main class="max-w-screen-xl mx-auto px-4 xl:px-0">
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-2xl font-medium">Hola, {{ .User.Username }}</h1>
  </div>

  <div data-behavior="vue">
    <div class="flex justify-end">
      <button
        @click="isEditMode = false; showModal = true"
        class="flex flex-row items-center bg-[#1A388B] text-white px-3 py-2 rounded-lg text-sm cursor-pointer"
      >
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24"
             viewBox="0 0 24 24" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
             class="lucide lucide-plus w-4 h-4 mr-2">
          <path d="M5 12h14"></path>
          <path d="M12 5v14"></path>
        </svg>
        Agregar Catec√∫meno
      </button>
    </div>

    <!-- üîπ Modal Din√°mico (Agregar/Editar) -->
    <modal-component :show="showModal" @close="showModal = false">
      <template #default>
        <p id="modalTitle" class="text-lg font-semibold mb-1">Agregar Catec√∫meno</p>
        <p id="modalSubtitle" class="text-gray-400 text-sm">Completa la informaci√≥n del catec√∫meno</p>
        <form id="catechumenForm" class="space-y-4 mt-5" method="post" onsubmit="return false;">
          <!-- Campos ocultos para edici√≥n -->
          <input type="hidden" id="catechumen_id" name="id">
          <input type="hidden" id="group_id" name="group_id">
          
          <div>
            <label for="full_name" class="form-label">Nombre Completo</label>
            <input type="text" id="full_name" name="full_name" required class="form-input" placeholder="Ej: Italo Luna">
          </div>
          <div>
            <label for="age" class="form-label">Edad</label>
            <input type="text" id="age" name="age" required class="form-input" placeholder="Ej: 15">
            <p class="text-gray-400 text-[13px] mt-1">Edad entre 5 y 18 a√±os</p>
          </div>
          <div>
            <label for="group_name" class="form-label">Grupo</label>
            <input type="text" id="group_name" class="form-input focus:outline-none" value="{{ .Group.Name }}" readonly>
            <p class="text-gray-500 text-sm mt-5">El QR se podr√° escanear solo 3 veces seg√∫n coordinaci√≥n</p>
          </div>
          <div class="flex justify-end space-x-2 mt-5">
            <button type="button" @click="showModal = false"
              class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors">
              Cancelar
            </button>
            <button type="button" id="submitBtn"
              class="flex flex-row items-center bg-[#1A388B] text-white px-3 py-2 rounded-lg text-sm cursor-pointer hover:bg-[#1A388B]/90 transition-colors">
              Agregar catec√∫meno
            </button>
          </div>
        </form>
      </template>
    </modal-component>


  </div>

  <div class="space-y-3 mt-6">
    <div id="catechumensList" class="space-y-3">
      <div class="text-gray-500 text-sm">‚è≥ Cargando catec√∫menos...</div>
    </div>
  </div>
</main>

<script>
document.addEventListener("DOMContentLoaded", () => {
  // catechumens loader
  async function loadCatechumens() {
    const list = document.getElementById("catechumensList");

    try {
      const res = await fetch("/catechumens");
      if (!res.ok) throw new Error(`HTTP error status: ${res.status}`);
      const data = await res.json();
      const catechumens = data.catechumens || [];

      list.innerHTML = "";

      if (catechumens.length === 0) {
        list.innerHTML = `<div class="text-gray-500 text-sm">No hay catec√∫menos registrados.</div>`;
        return;
      }

      catechumens.forEach(c => {
        const container = document.createElement("div");
        container.innerHTML = `
          <div class="bg-white p-3 sm:p-5 rounded-xl border-1 border-gray-200 hover:shadow-md transition-all max-w-full">
            <div class="flex flex-row items-center justify-between gap-2 sm:gap-0">
              <div class="flex flex-row items-center gap-2 sm:gap-4 min-w-0 flex-1">
                <div class="w-12 h-12 rounded-xl bg-[#1A388B]/10 flex items-center justify-center flex-shrink-0">
                  <svg xmlns=\"http://www.w3.org/2000/svg\" width=\"24\" height=\"24\" fill=\"none\" stroke=\"currentColor\"
                    stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"
                    class=\"w-6 h-6 text-[#1A388B]\">
                    <path d=\"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2\"></path>
                    <circle cx=\"12\" cy=\"7\" r=\"4\"></circle>
                  </svg>
                </div>
                <div class="flex flex-col gap-1">
                  <div class="flex flex-row gap-2 items-center">
                    <p class="font-normal break-words text-sm sm:text-base truncate">${c.full_name}</p>
                    <p class="text-xs sm:text-[13px] text-gray-500 block sm:hidden">- ${c.age} a√±os</p>
                  </div>
                  <div class="flex flex-row items-center gap-2 sm:gap-3 flex-wrap">
                    <p class="text-xs bg-gray-200 px-2 rounded-lg py-1 truncate">${c.group.name}</p>
                    <p class="text-xs sm:text-[13px] text-gray-500 hidden sm:block">${c.age} a√±os</p>
                    <p class="text-xs sm:text-[13px] text-gray-500">‚Ä¢ 2/4 escaneos</p>
                  </div>
                </div>
              </div>
              <div class="flex flex-row gap-2 sm:gap-3 flex-shrink-0">
                <button 
                  data-edit-catechumen='${JSON.stringify(c).replace(/'/g, "&#39;")}'
                  class="edit-btn px-3 sm:px-4 py-2 text-[#1A388B] bg-[#1A388B]/20 rounded-lg text-xs sm:text-sm font-medium hover:opacity-80 transition-all cursor-pointer">
                  Editar
                </button>
                <button
                  class="px-3 sm:px-4 py-2 text-red-500 bg-red-500/20 rounded-lg text-xs sm:text-sm font-medium hover:opacity-80 transition-all cursor-pointer">
                  Eliminar
                </button>
              </div>
            </div>
          </div>
        `;
        list.appendChild(container);
      });

      console.log("Catec√∫menos renderizados:", catechumens.length);
    } catch (err) {
      console.error("Error cargando catec√∫menos:", err);
      list.innerHTML = `<div class="text-red-600 text-sm">Error al cargar catec√∫menos: ${err.message}</div>`;
    }
  }

  async function submitForm() {
    const form = document.getElementById("catechumenForm");

    const isEdit = window.vm && window.vm.isEditMode;
    const fullName = form.full_name.value.trim();
    const age = form.age.value.trim();

    if (!fullName || !age) {
      alert("Por favor completa todos los campos");
      return;
    }

    try {
      let response;
      
      if (isEdit) {
        const catechumenId = form.id ? form.id.value.trim() : "";
        const groupId = form.group_id ? form.group_id.value.trim() : "";
        
        response = await fetch(`/catechumen/${catechumenId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `id=${encodeURIComponent(catechumenId)}&full_name=${encodeURIComponent(fullName)}&age=${encodeURIComponent(age)}&group_id=${encodeURIComponent(groupId)}`
        });
      } else {
        response = await fetch("/add-catechumen", {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: `full_name=${encodeURIComponent(fullName)}&age=${encodeURIComponent(age)}`
        });
      }

      if (!response.ok) throw new Error(await response.text());

      const data = await response.json();

      form.reset();
      if (window.vm) window.vm.showModal = false;

      await loadCatechumens();
    } catch (error) {
      console.error("üí• Error de conexi√≥n:", error);
      alert("Error de conexi√≥n: " + error.message);
    }
  }

  window.openEditModal = function(catechumen) {
    console.log("üîß Abriendo modal de edici√≥n para:", catechumen);
    
    if (window.vm) {
      window.vm.isEditMode = true;
      window.vm.showModal = true;

      window.vm.$nextTick(() => {
        const modalTitle = document.getElementById("modalTitle");
        const modalSubtitle = document.getElementById("modalSubtitle");
        const submitBtn = document.getElementById("submitBtn");
        
        if (modalTitle) modalTitle.textContent = "Editar Catec√∫meno";
        if (modalSubtitle) modalSubtitle.textContent = "Modifica la informaci√≥n del catec√∫meno";
        if (submitBtn) submitBtn.textContent = "Actualizar catec√∫meno";

        const catechumenId = document.getElementById("catechumen_id");
        const fullName = document.getElementById("full_name");
        const age = document.getElementById("age");
        const groupId = document.getElementById("group_id");
        const groupName = document.getElementById("group_name");
        
        if (catechumenId) catechumenId.value = catechumen.id;
        if (fullName) fullName.value = catechumen.full_name;
        if (age) age.value = catechumen.age;
        if (groupId) groupId.value = catechumen.group.id;
        if (groupName) groupName.value = catechumen.group.name;

        console.log("‚úÖ Modal configurado para edici√≥n (nextTick)");
      });
    }
  };

  loadCatechumens();

  document.addEventListener("click", (e) => {
    if (e.target && e.target.id === "submitBtn") submitForm();

    if (e.target && e.target.classList.contains("edit-btn")) {
      const catechumenData = e.target.getAttribute("data-edit-catechumen");
      if (catechumenData) {
        try {
          const catechumen = JSON.parse(catechumenData);
          window.openEditModal(catechumen);
        } catch (err) {
          console.error("Error parsing catechumen data:", err);
        }
      }
    }
  });
});
</script>


{{ end }}
