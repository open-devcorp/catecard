{{ define "content" }}
<main class="max-w-screen-xl mx-auto">
    <h2 class="text-2xl font-semibold">Hola, Administrador</h2>
    <h3 class="text-lg text-slate-600">Aqui esta el resumen de tu categoria</h3>

    <section class="grid grid-cols-3 gap-8 mt-8">
        <article class="bg-white rounded-xl border border-gray-300 p-6">
            <div class="flex justify-between items-center">
                <p>Total Grupos</p>

                <div class="aspect-square rounded-3xl size-10 bg-blue-300 text-blue-800">
                    <!-- svg -->
                </div>
            </div>

            <div class="mt-12">
                <p id="totalGroupsCount" class="text-4xl">4</p>
                <p class="text-sm text-slate-600">Grupos</p>
            </div>
        </article>

        <article class="bg-white rounded-xl border border-gray-300 p-6">
            <div class="flex justify-between items-center">
                <p>Total Catequistas</p>

                <div class="aspect-square rounded-3xl size-10 bg-blue-300 text-blue-800">
                    <!-- svg -->
                </div>
            </div>

            <div class="mt-12">
                <p id="totalCatechistsCount" class="text-4xl">4</p>
                <p class="text-sm text-slate-600">Catequistas registrados</p>
            </div>
        </article>

        <article class="bg-white rounded-xl border border-gray-300 p-6">
            <div class="flex justify-between items-center">
                <p>Total Catecúmenos</p>

                <div class="aspect-square rounded-3xl size-10 bg-blue-300 text-blue-800">
                    <!-- svg -->
                </div>
            </div>

            <div class="mt-12">
                <p id="totalCatecumenosCount" class="text-4xl">4</p>
                <p class="text-sm text-slate-600">Catecúmenos inscritos</p>
            </div>
        </article>
    </section>

    <section class="my-8">
        <div class="rounded-full bg-slate-200 py-1 px-2 flex gap-3 w-fit" role="tablist" aria-label="Secciones">
            <button id="tabGroups" class="px-3 py-1 rounded-full text-slate-700 font-medium" role="tab" aria-selected="false">Grupos</button>
            <button id="tabUsers" class="px-3 py-1 rounded-full text-slate-700 font-medium" role="tab" aria-selected="false">Usuarios</button>
            <button id="tabDB" class="px-3 py-1 rounded-full text-slate-700 font-medium" role="tab" aria-selected="false">Base de Datos</button>
        </div>
    </section>

    <section class="bg-white rounded-xl border border-gray-300 p-6">
        <div class="flex justify-between items-center">
            <h3>
                <p class="">Gestión de Usuarios</p>
                <p class="text-slate-700 text-xs">Crea y administra cuenta de catequistas y escáneres</p>
            </h3>

            <div class="flex items-center gap-2">
            <button id="openNewUserModal" class="bg-blue-900 p-2 text-white rounded-md flex items-center gap-1">
                <!-- plus icon -->
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="size-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>

                <p>Nuevo Usuario</p>
            </button>
                
            </div>
        </div>

    <div id="usersSection">
    <article class="mt-8">
            <div class="flex items-center justify-between">
                <p class="font-medium">Catequistas <span id="catechistsHeaderCount" class="text-sm text-slate-600">(0)</span></p>
                <button id="refreshCatechists" class="text-sm text-blue-700">Actualizar</button>
            </div>

            <div id="catechistsList" class="mt-4 space-y-3">
                <!-- catechists rendered here -->
            </div>
    </article>

    </div>

    <!-- Lista de Grupos -->
    <div id="groupsSection" class="hidden">
    <article class="mt-8">
            <div class="flex items-center justify-between">
                <p class="font-medium">Grupos <span id="groupsHeaderCount" class="text-sm text-slate-600">(0)</span></p>
                <div class="flex items-center gap-2">
                    <button id="openNewGroupModal" class="bg-green-600 p-2 text-white rounded-md flex items-center gap-2 text-sm">Nuevo Grupo</button>
                    <button id="refreshGroups" class="text-sm text-blue-700">Actualizar</button>
                </div>
            </div>
            <div id="groupsList" class="mt-4 space-y-3">
                <!-- groups rendered here -->
            </div>
        </article>
        </div>

        <div id="dbSection" class="hidden">
            <article class="mt-8">
                <p class="font-medium">Base de Datos</p>
                <p class="text-sm text-slate-500 mt-2">Herramientas y estado de la base de datos</p>
                <!-- placeholder: aquí puedes mostrar migraciones, backups, etc. -->
            </article>
        </div>

                <!-- Modal: Create New Group -->
                <div id="newGroupModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">
                    <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4 p-6">
                        <header class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-medium">Crear grupo</h3>
                            <button id="closeNewGroupModal" class="text-gray-500">✕</button>
                        </header>
                        <div id="groupModalBody">
                            <form id="newGroupForm" class="space-y-3">
                                <div>
                                    <label class="block text-sm text-gray-700">Nombre del grupo</label>
                                    <input name="name" required type="text" class="mt-1 block w-full rounded-md border-gray-300 p-2" placeholder="Grupo 1 - Iniciación">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-700">Catequista</label>
                                    <input name="catechist_id" type="text" class="mt-1 block w-full rounded-md border-gray-300 p-2" placeholder="Descripción corta">
                                </div>
                                <div class="flex justify-end gap-2 mt-2">
                                    <button type="button" id="cancelNewGroup" class="px-3 py-2 rounded-md border">Cancelar</button>
                                    <button type="submit" id="submitNewGroup" class="px-3 py-2 rounded-md bg-green-600 text-white">Crear</button>
                                </div>
                                <div id="newGroupFeedback" class="text-sm mt-2 text-gray-700"></div>
                            </form>
                        </div>
                    </div>
                </div>


        <article class="mt-4">
            <div class="flex items-center justify-between">
                <p class="font-medium">Cuentas de Escáner</p>
                <div class="flex gap-2 items-center">
                    <button id="refreshScanners" class="px-3 py-1 rounded-md bg-blue-600 text-white text-sm">Actualizar</button>
                    <span id="scannersStatus" class="text-sm text-gray-600"></span>
                </div>
            </div>

            <div id="scannersList" class="mt-2">
                <!-- Se llenará dinámicamente por fetchScanners() -->
                <div class="text-sm text-gray-500">Cargando escáneres...</div>
            </div>
        </article>
    </section>

                <!-- Modal: Create New User (simplified) -->
                <div id="newUserModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">
                    <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4 p-6">
                        <header class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-medium">Crear usuario</h3>
                            <button id="closeNewUserModal" class="text-gray-500">✕</button>
                        </header>

                        <div id="modalBody">
                            <form id="newUserForm" class="space-y-3">
                                <div>
                                    <label class="block text-sm text-gray-700">Usuario</label>
                                    <input name="username" required type="text" class="mt-1 block w-full rounded-md border-gray-300 p-2" placeholder="usuario@ejemplo.com">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-700">Email</label>
                                    <input name="email" required type="email" class="mt-1 block w-full rounded-md border-gray-300 p-2" placeholder="email@ejemplo.com">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-700">Tipo de cuenta</label>
                                    <select name="role" class="mt-1 block w-full rounded-md border-gray-300 p-2">
                                        <option value="1" selected>Catequista</option>
                                        <option value="3">Escáner</option>
                                    </select>
                                </div>
                                <div class="flex justify-end gap-2 mt-2">
                                    <button type="button" id="cancelNewUser" class="px-3 py-2 rounded-md border">Cancelar</button>
                                    <button type="submit" id="submitNewUser" class="px-3 py-2 rounded-md bg-blue-900 text-white">Crear</button>
                                </div>
                                <div id="newUserFeedback" class="text-sm mt-2 text-red-600"></div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Modal: User Details (Ver Credenciales) -->
                <div id="userDetailsModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">
                    <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4 p-6">
                        <header class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-medium">Credenciales del usuario</h3>
                            <button id="closeUserDetailsModal" class="text-gray-500">✕</button>
                        </header>
                        <div id="userDetailsBody">
                            <!-- contenido rellenado por JS -->
                        </div>
                    </div>
                </div>

                <!-- Modal: Group Details (Ver) -->
                <div id="groupDetailsModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">
                    <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4 p-6">
                        <header class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-medium">Detalles del grupo</h3>
                            <button id="closeGroupDetailsModal" class="text-gray-500">✕</button>
                        </header>
                        <div id="groupDetailsBody">
                            <!-- contenido rellenado por JS -->
                        </div>
                    </div>
                </div>

                <!-- Modal: Edit Group -->
                <div id="editGroupModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">
                    <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4 p-6">
                        <header class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-medium">Editar grupo</h3>
                            <button id="closeEditGroupModal" class="text-gray-500">✕</button>
                        </header>
                        <div id="editGroupBody">
                            <form id="editGroupForm" class="space-y-3">
                                <input type="hidden" name="id" id="editGroupId">
                                <div>
                                    <label class="block text-sm text-gray-700">Nombre</label>
                                    <input name="name" id="editGroupName" required type="text" class="mt-1 block w-full rounded-md border-gray-300 p-2" placeholder="Nombre del grupo">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-700">Catequista ID</label>
                                    <input name="catechist_id" id="editGroupCatechist" type="text" class="mt-1 block w-full rounded-md border-gray-300 p-2" placeholder="ID del catequista">
                                </div>
                                <div class="flex justify-end gap-2 mt-2">
                                    <button type="button" id="cancelEditGroup" class="px-3 py-2 rounded-md border">Cancelar</button>
                                    <button type="submit" id="submitEditGroup" class="px-3 py-2 rounded-md bg-yellow-400 text-white">Guardar</button>
                                </div>
                                <div id="editGroupFeedback" class="text-sm mt-2 text-red-600"></div>
                            </form>
                        </div>
                    </div>
                </div>
                <script>
                (function(){
                    const openBtn = document.getElementById('openNewUserModal');
                    const modal = document.getElementById('newUserModal');
                    const closeBtn = document.getElementById('closeNewUserModal');
                    const cancelBtn = document.getElementById('cancelNewUser');
                    const form = document.getElementById('newUserForm');
                    const feedback = document.getElementById('newUserFeedback');
                    const modalBody = document.getElementById('modalBody');

                    function open(){ modal.classList.remove('hidden'); modal.classList.add('flex'); }
                    function close(){ modal.classList.remove('flex'); modal.classList.add('hidden'); feedback.textContent = ''; form && form.reset(); restoreForm(); }

                    function showResult(user){
                        // replace form with simple result block
                        modalBody.innerHTML = `
                            <div class="py-2">
                                <h4 class="text-lg font-medium mb-2">Usuario creado</h4>
                                <p class="text-sm">Usuario: <strong>${user.username}</strong></p>
                                <p class="text-sm">Email: <strong>${user.email}</strong></p>
                                <p class="text-sm">Contraseña: <strong>${user.password}</strong></p>
                            </div>
                            <div class="flex justify-end gap-2 mt-4">
                                <button id="closeAfterCreate" class="px-3 py-2 rounded-md border">Cerrar</button>
                                <button id="createAnother" class="px-3 py-2 rounded-md bg-blue-900 text-white">Crear otro</button>
                            </div>
                        `;

                        document.getElementById('closeAfterCreate').addEventListener('click', function(){ close(); });
                        document.getElementById('createAnother').addEventListener('click', function(){ restoreForm(); });
                        // refresh catechists list after creating a user
                        if(typeof fetchCatechists === 'function') fetchCatechists();
                    }

                    function restoreForm(){
                        modalBody.innerHTML = `
                            <form id="newUserForm" class="space-y-3">
                                <div>
                                    <label class="block text-sm text-gray-700">Usuario</label>
                                    <input name="username" required type="text" class="mt-1 block w-full rounded-md border-gray-300 p-2" placeholder="usuario@ejemplo.com">
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-700">Email</label>
                                    <input name="email" required type="email" class="mt-1 block w-full rounded-md border-gray-300 p-2" placeholder="email@ejemplo.com">
                                </div>
                                <input type="hidden" name="role" value="1">
                                <div class="flex justify-end gap-2 mt-2">
                                    <button type="button" id="cancelNewUser" class="px-3 py-2 rounded-md border">Cancelar</button>
                                    <button type="submit" id="submitNewUser" class="px-3 py-2 rounded-md bg-blue-900 text-white">Crear</button>
                                </div>
                                <div id="newUserFeedback" class="text-sm mt-2 text-red-600"></div>
                            </form>
                        `;

                        // re-bind handlers
                        const newForm = document.getElementById('newUserForm');
                        const newCancel = document.getElementById('cancelNewUser');
                        newCancel && newCancel.addEventListener('click', function(e){ e.preventDefault(); close(); });
                        newForm && newForm.addEventListener('submit', submitHandler);
                    }

                    function sleep(ms){ return new Promise(res=>setTimeout(res, ms)); }

                    async function submitHandler(e){
                        e && e.preventDefault();
                        const btn = document.getElementById('submitNewUser');
                        const formEl = e ? e.target : document.getElementById('newUserForm');
                        const fd = new FormData(formEl);

                        feedback.textContent = 'Creando...';
                        btn.disabled = true;
                        const maxAttempts = 3;
                        const retryDelay = 900; // ms
                        let attempt = 0;
                        for(attempt = 1; attempt <= maxAttempts; attempt++){
                            try{
                                const resp = await fetch('/add-catechist', {
                                    method: 'POST',
                                    body: new URLSearchParams(Array.from(fd.entries())),
                                    credentials: 'same-origin',
                                    headers: { 'Accept': 'application/json' }
                                });
                                const data = await resp.json().catch(()=>null);

                                // if unauthorized/forbidden, show server message immediately (no retries)
                                if (resp.status === 401 || resp.status === 403) {
                                    const serverMsg = data && data.message ? data.message : 'No autorizado';
                                    feedback.textContent = serverMsg;
                                    btn.disabled = false;
                                    return;
                                }

                                if(resp.ok && data && data.user){
                                    feedback.textContent = '';
                                    showResult(data.user);
                                    btn.disabled = false;
                                    return;
                                }

                                // if not ok and still attempts left, wait and retry silently
                                if(attempt < maxAttempts){
                                    await sleep(retryDelay);
                                    continue;
                                }

                                // exhausted attempts: show server message if available, otherwise generic
                                const serverMsg = data && data.message ? data.message : (resp && resp.statusText ? resp.statusText : 'Error creando usuario');
                                feedback.textContent = serverMsg;
                                break;
                            }catch(err){
                                if(attempt < maxAttempts){
                                    await sleep(retryDelay);
                                    continue;
                                }
                                // network error after retries: show generic network error
                                console.error('network error creating user after retries', err);
                                feedback.textContent = 'Error de red';
                                break;
                            }
                        }

                        // final cleanup: re-enable button (keep any feedback message visible)
                        btn.disabled = false;
                    }

                    openBtn && openBtn.addEventListener('click', function(e){ e.preventDefault(); open(); });
                    closeBtn && closeBtn.addEventListener('click', function(e){ e.preventDefault(); close(); });
                    cancelBtn && cancelBtn.addEventListener('click', function(e){ e.preventDefault(); close(); });

                    // initial bind
                    form && form.addEventListener('submit', submitHandler);
                })();
                </script>

                                <script>
                                (function(){
                                    const openGroupBtn = document.getElementById('openNewGroupModal');
                                    const modal = document.getElementById('newGroupModal');
                                    const closeBtn = document.getElementById('closeNewGroupModal');
                                    const cancelBtn = document.getElementById('cancelNewGroup');
                                    const form = document.getElementById('newGroupForm');
                                    const feedback = document.getElementById('newGroupFeedback');

                                    // Modal that will show the created group's info
                                    const createdModalHtml = `
                                        <div id="groupCreatedModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">
                                            <div class="bg-white rounded-lg shadow-lg w-full max-w-md mx-4 p-6">
                                                <header class="flex items-center justify-between mb-4">
                                                    <h3 class="text-lg font-medium">Grupo creado</h3>
                                                    <button id="closeGroupCreatedModal" class="text-gray-500">✕</button>
                                                </header>
                                                <div id="groupCreatedBody">
                                                    <!-- contenido rellenado por JS -->
                                                </div>
                                            </div>
                                        </div>
                                    `;

                                    // Insert created modal into DOM (once)
                                    if (!document.getElementById('groupCreatedModal')){
                                        const wrapper = document.createElement('div');
                                        wrapper.innerHTML = createdModalHtml;
                                        document.body.appendChild(wrapper.firstElementChild);
                                    }

                                    const createdModal = document.getElementById('groupCreatedModal');
                                    const createdBody = document.getElementById('groupCreatedBody');
                                    const closeCreatedBtn = () => document.getElementById('closeGroupCreatedModal');

                                    function open(){ modal.classList.remove('hidden'); modal.classList.add('flex'); }
                                    function close(){ modal.classList.remove('flex'); modal.classList.add('hidden'); feedback.textContent = ''; form && form.reset(); }

                                    function openCreated(){ createdModal.classList.remove('hidden'); createdModal.classList.add('flex'); }
                                    function closeCreated(){ createdModal.classList.remove('flex'); createdModal.classList.add('hidden'); createdBody.innerHTML = ''; }

                                    openGroupBtn && openGroupBtn.addEventListener('click', function(e){ e.preventDefault(); open(); });
                                    closeBtn && closeBtn.addEventListener('click', function(e){ e.preventDefault(); close(); });
                                    cancelBtn && cancelBtn.addEventListener('click', function(e){ e.preventDefault(); close(); });

                                    // bind close button for created modal (delegated in case it's not present immediately)
                                    document.addEventListener('click', function(ev){
                                        if(ev.target && ev.target.id === 'closeGroupCreatedModal'){
                                            ev.preventDefault(); closeCreated();
                                        }
                                        if(ev.target && ev.target.id === 'createAnotherGroup'){
                                            ev.preventDefault(); closeCreated(); open();
                                        }
                                    });

                                    form && form.addEventListener('submit', async function(e){
                                        e.preventDefault();
                                        const btn = document.getElementById('submitNewGroup');
                                        const fd = new FormData(form);
                                        btn.disabled = true;
                                        feedback.textContent = 'Creando grupo...';
                                        try{
                                            const resp = await fetch('/add-group', {
                                                method: 'POST',
                                                body: new URLSearchParams(Array.from(fd.entries())),
                                                credentials: 'same-origin',
                                                headers: { 'Accept': 'application/json' }
                                            });
                                            const data = await resp.json().catch(()=>null);
                                            if(resp.ok && data){
                                                // show created modal with returned group info
                                                const grp = data.group || {};
                                                const msg = data.message || 'Grupo creado';
                                                createdBody.innerHTML = `
                                                    <div class="py-2">
                                                        <h4 class="text-lg font-medium mb-2">${msg}</h4>
                                                        <p class="text-sm">ID: <strong>${grp.id ?? ''}</strong></p>
                                                        <p class="text-sm">Nombre: <strong>${grp.name ?? ''}</strong></p>
                                                        <p class="text-sm">Catequista ID: <strong>${grp.catechist_id ?? grp.CatechistId ?? ''}</strong></p>
                                                    </div>
                                                    <div class="flex justify-end gap-2 mt-4">
                                                        <button id="closeCreatedOnly" class="px-3 py-2 rounded-md border">Cerrar</button>
                                                        <button id="createAnotherGroup" class="px-3 py-2 rounded-md bg-green-600 text-white">Crear otro</button>
                                                    </div>
                                                `;

                                                // close the creation modal and open the created modal
                                                close();
                                                openCreated();
                                                // refresh groups list so new group appears without reload
                                                if(typeof fetchGroups === 'function') fetchGroups();
                                                return;
                                            }
                                            feedback.textContent = data && data.message ? data.message : 'Error creando grupo';
                                        }catch(err){
                                            feedback.textContent = 'Error de red';
                                        }finally{ btn.disabled = false; }
                                    });
                                })();
                                </script>

                <script>
                (function(){
                    const catechistsUrl = '/all-catechists';
                    const groupsUrl = '/all-groups';
                    const scannersUrl = '/all-scanners';

                    const catechistsList = document.getElementById('catechistsList');
                    const groupsList = document.getElementById('groupsList');
                    const scannersList = document.getElementById('scannersList');
                    const scannersStatus = document.getElementById('scannersStatus');
                    const totalGroupsCount = document.getElementById('totalGroupsCount');
                    const totalCatechistsCount = document.getElementById('totalCatechistsCount');
                    const catechistsHeaderCount = document.getElementById('catechistsHeaderCount');
                    const groupsHeaderCount = document.getElementById('groupsHeaderCount');
                    const refreshCatechists = document.getElementById('refreshCatechists');
                    const refreshGroups = document.getElementById('refreshGroups');
                    const refreshScanners = document.getElementById('refreshScanners');
                    function renderCatechists(items){
                        catechistsList.innerHTML = '';
                        if(!items || items.length === 0){
                            catechistsList.innerHTML = '<p class="text-sm text-slate-500">No hay catequistas registrados</p>';
                            catechistsHeaderCount.textContent = '(0)';
                            totalCatechistsCount.textContent = '0';
                            return;
                        }
                        catechistsHeaderCount.textContent = `(${items.length})`;
                        totalCatechistsCount.textContent = String(items.length);
                        items.forEach(function(u){
                            const el = document.createElement('div');
                            el.className = 'flex items-center justify-between rounded-lg border border-gray-300 my-2 p-4';
                            const left = document.createElement('div');
                            left.className = 'flex gap-2 items-center';
                            left.innerHTML = `
                                <div class="bg-blue-400 text-blue-800 aspect-square rounded-xl size-10"></div>
                                <div>
                                    <p>${u.username || u.email || 'Usuario'}</p>
                                    <p class="mt-1 text-slate-500 font-medium text-xs">${u.email || ''} · <span class="p-1 rounded-md text-slate-700 bg-slate-300">${u.group_name || u.group || ''}</span></p>
                                </div>
                            `;
                            const right = document.createElement('div');
                            right.className = 'flex gap-2';
                            right.innerHTML = `
                                <button class="bg-gray-100 border border-gray-400 rounded-md text-gray-700 font-medium py-1 px-2 view-credentials" data-id="${u.id}">Ver Credenciales</button>
                                <button class="text-red-600 delete-user" data-id="${u.id}">Eliminar</button>
                            `;
                            el.appendChild(left);
                            el.appendChild(right);
                            catechistsList.appendChild(el);
                        });
                    }

                    function renderScanners(items){
                        scannersList.innerHTML = '';
                        if(!items || items.length === 0){
                            scannersList.innerHTML = '<p class="text-sm text-slate-500">No hay cuentas de escáner</p>';
                            scannersStatus.textContent = '(0)';
                            return;
                        }
                        scannersStatus.textContent = `(${items.length})`;
                        items.forEach(function(s){
                            const el = document.createElement('div');
                            el.className = 'flex items-center justify-between rounded-lg border border-gray-300 my-2 p-4';
                            el.innerHTML = `
                                <div class="flex gap-2 items-center">
                                    <div class="bg-blue-400 text-blue-800 aspect-square rounded-xl size-10"></div>
                                    <div>
                                        <p>${s.name || s.username || s.email || 'Escáner'}</p>
                                        <p class="mt-1 text-slate-500 font-medium text-xs">${s.email || ''} · <span class="p-1 rounded-md text-slate-700 bg-slate-300">${s.group_name || s.group || ''}</span></p>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button class="bg-gray-100 border border-gray-400 rounded-md text-gray-700 font-medium py-1 px-2 view-credentials" data-id="${s.id}">Ver Credenciales</button>
                                    <button class="text-red-600 delete-user" data-id="${s.id}">Eliminar</button>
                                </div>
                            `;
                            scannersList.appendChild(el);
                        });
                    }

                    async function fetchScanners(){
                        if(scannersStatus) scannersStatus.textContent = 'Cargando...';
                        try{
                            const resp = await fetch(scannersUrl, { credentials: 'same-origin', headers: { 'Accept': 'application/json' } });
                            if(!resp.ok){
                                if(scannersStatus) scannersStatus.textContent = 'Error '+resp.status;
                                return renderScanners([]);
                            }
                            const data = await resp.json().catch(()=>null);
                            if(!data){ if(scannersStatus) scannersStatus.textContent = 'Respuesta inválida'; return renderScanners([]); }
                            const items = Array.isArray(data) ? data : (data.scanners || data);
                            if(scannersStatus) scannersStatus.textContent = '';
                            renderScanners(items || []);
                        }catch(err){
                            console.error('fetch scanners error', err);
                            if(scannersStatus) scannersStatus.textContent = 'Error de red';
                            renderScanners([]);
                        }
                    }

                    function renderGroups(items){
                        groupsList.innerHTML = '';
                        if(!items || items.length === 0){
                            groupsList.innerHTML = '<p class="text-sm text-slate-500">No hay grupos</p>';
                            groupsHeaderCount.textContent = '(0)';
                            totalGroupsCount.textContent = '0';
                            return;
                        }
                        groupsHeaderCount.textContent = `(${items.length})`;
                        totalGroupsCount.textContent = String(items.length);
                        items.forEach(function(g){
                            const el = document.createElement('div');
                            el.className = 'flex items-center justify-between rounded-lg border border-gray-300 my-2 p-4';
                            el.innerHTML = `
                                <div class="flex gap-2 items-center">
                                    <div class="bg-green-200 text-green-800 aspect-square rounded-xl size-10"></div>
                                    <div>
                                        <p>${g.name || 'Grupo'}</p>
                                        <p class="mt-1 text-slate-500 font-medium text-xs">ID: ${g.id || ''} · Catequista ID: ${g.catechist_id ?? g.CatechistId ?? ''}</p>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button class="bg-gray-100 border border-gray-400 rounded-md text-gray-700 font-medium py-1 px-2 view-group" data-id="${g.id}">Ver</button>
                                    <button class="bg-yellow-100 border border-yellow-400 rounded-md text-yellow-800 font-medium py-1 px-2 edit-group" data-id="${g.id}" data-name="${g.name}" data-catechist="${g.catechist_id ?? g.CatechistId ?? ''}">Editar</button>
                                    <button class="text-red-600 delete-group" data-id="${g.id}">Eliminar</button>
                                </div>
                            `;
                            groupsList.appendChild(el);
                        });
                    }

                    async function fetchCatechists(){
                        try{
                            const resp = await fetch(catechistsUrl, { credentials: 'same-origin', headers: { 'Accept': 'application/json' } });
                            if(!resp.ok) return renderCatechists([]);
                            const data = await resp.json().catch(()=>null);
                            if(!data) return renderCatechists([]);
                            // if server returns array directly or {status, users}
                            const items = Array.isArray(data) ? data : (data.users || data.catechists || data);
                            renderCatechists(items || []);
                        }catch(err){
                            console.error('fetch catechists error', err);
                            renderCatechists([]);
                        }
                    }

                    async function fetchGroups(){
                        try{
                            const resp = await fetch(groupsUrl, { credentials: 'same-origin', headers: { 'Accept': 'application/json' } });
                            if(!resp.ok) return renderGroups([]);
                            const data = await resp.json().catch(()=>null);
                            if(!data) return renderGroups([]);
                            const items = Array.isArray(data) ? data : (data.groups || data);
                            renderGroups(items || []);
                        }catch(err){
                            console.error('fetch groups error', err);
                            renderGroups([]);
                        }
                    }

                    refreshCatechists && refreshCatechists.addEventListener('click', function(e){ e.preventDefault(); fetchCatechists(); });
                    refreshGroups && refreshGroups.addEventListener('click', function(e){ e.preventDefault(); fetchGroups(); });
                    refreshScanners && refreshScanners.addEventListener('click', function(e){ e.preventDefault(); fetchScanners(); });

                    // initial load
                    fetchCatechists();
                    fetchGroups();
                    fetchScanners();

                    // Edit group form handling
                    const editGroupModal = document.getElementById('editGroupModal');
                    const editGroupForm = document.getElementById('editGroupForm');
                    const closeEditGroup = document.getElementById('closeEditGroupModal');
                    const cancelEditGroup = document.getElementById('cancelEditGroup');
                    const editFeedback = document.getElementById('editGroupFeedback');

                    closeEditGroup && closeEditGroup.addEventListener('click', function(e){ e.preventDefault(); if(editGroupModal){ editGroupModal.classList.remove('flex'); editGroupModal.classList.add('hidden'); } });
                    cancelEditGroup && cancelEditGroup.addEventListener('click', function(e){ e.preventDefault(); if(editGroupModal){ editGroupModal.classList.remove('flex'); editGroupModal.classList.add('hidden'); } });

                    editGroupForm && editGroupForm.addEventListener('submit', async function(e){
                        e.preventDefault();
                        const btn = document.getElementById('submitEditGroup');
                        btn && (btn.disabled = true);
                        editFeedback && (editFeedback.textContent = 'Guardando...');
                        const fd = new FormData(editGroupForm);
                        const id = fd.get('id');
                        try{
                            const resp = await fetch('/edit-group/'+id, { method: 'PUT', credentials: 'same-origin', body: new URLSearchParams(Array.from(fd.entries())), headers: { 'Accept': 'application/json' } });
                            const data = await resp.json().catch(()=>null);
                            if(!resp.ok){
                                const msg = data && data.message ? data.message : resp.statusText || 'Error';
                                editFeedback && (editFeedback.textContent = msg);
                                btn && (btn.disabled = false);
                                return;
                            }
                            // success
                            editFeedback && (editFeedback.textContent = 'Guardado');
                            if(typeof fetchGroups === 'function') fetchGroups();
                            // close modal
                            if(editGroupModal){ editGroupModal.classList.remove('flex'); editGroupModal.classList.add('hidden'); }
                        }catch(err){
                            console.error('edit group error', err);
                            editFeedback && (editFeedback.textContent = 'Error de red');
                        }finally{ btn && (btn.disabled = false); }
                    });

                    // User details modal handling
                    const userDetailsModal = document.getElementById('userDetailsModal');
                    const userDetailsBody = document.getElementById('userDetailsBody');
                    const closeUserDetails = document.getElementById('closeUserDetailsModal');

                    function openUserDetails(){ if(userDetailsModal) { userDetailsModal.classList.remove('hidden'); userDetailsModal.classList.add('flex'); } }
                    function closeUserDetailsModal(){ if(userDetailsModal) { userDetailsModal.classList.remove('flex'); userDetailsModal.classList.add('hidden'); userDetailsBody.innerHTML = ''; } }
                    closeUserDetails && closeUserDetails.addEventListener('click', function(e){ e.preventDefault(); closeUserDetailsModal(); });

                    async function fetchUserById(id){
                        try{
                            const resp = await fetch('/user/'+id, { credentials: 'same-origin', headers: { 'Accept': 'application/json' } });
                            if(!resp.ok){
                                const txt = await resp.text().catch(()=>resp.statusText||'Error');
                                userDetailsBody.innerHTML = `<p class="text-sm text-red-600">Error: ${resp.status} ${txt}</p>`;
                                openUserDetails();
                                return;
                            }
                            const data = await resp.json().catch(()=>null);
                            if(!data){ userDetailsBody.innerHTML = '<p class="text-sm text-red-600">Respuesta inválida</p>'; openUserDetails(); return; }

                            // Expecting the handler to return a user object
                            const u = data;
                            userDetailsBody.innerHTML = `
                                <div>
                                    <p class="text-sm">ID: <strong>${u.id ?? ''}</strong></p>
                                    <p class="text-sm">Usuario: <strong>${u.username ?? u.email ?? ''}</strong></p>
                                    <p class="text-sm">Email: <strong>${u.email ?? ''}</strong></p>
                                    <p class="text-sm">Role: <strong>${u.role ?? ''}</strong></p>
                                    <p class="text-sm">Password (si está): <strong>${u.password ?? ''}</strong></p>
                                </div>
                            `;
                            openUserDetails();
                        }catch(err){
                            console.error('fetch user by id error', err);
                            userDetailsBody.innerHTML = '<p class="text-sm text-red-600">Error de red</p>'; openUserDetails();
                        }
                    }

                    // Group details modal handling
                    const groupDetailsModal = document.getElementById('groupDetailsModal');
                    const groupDetailsBody = document.getElementById('groupDetailsBody');
                    const closeGroupDetails = document.getElementById('closeGroupDetailsModal');

                    function openGroupDetails(){ if(groupDetailsModal) { groupDetailsModal.classList.remove('hidden'); groupDetailsModal.classList.add('flex'); } }
                    function closeGroupDetailsModal(){ if(groupDetailsModal) { groupDetailsModal.classList.remove('flex'); groupDetailsModal.classList.add('hidden'); groupDetailsBody.innerHTML = ''; } }
                    closeGroupDetails && closeGroupDetails.addEventListener('click', function(e){ e.preventDefault(); closeGroupDetailsModal(); });

                    async function fetchGroupById(id){
                        try{
                            const resp = await fetch('/group/'+id, { credentials: 'same-origin', headers: { 'Accept': 'application/json' } });
                            if(!resp.ok){
                                const txt = await resp.text().catch(()=>resp.statusText||'Error');
                                groupDetailsBody.innerHTML = `<p class="text-sm text-red-600">Error: ${resp.status} ${txt}</p>`;
                                openGroupDetails();
                                return;
                            }
                            const data = await resp.json().catch(()=>null);
                            if(!data){ groupDetailsBody.innerHTML = '<p class="text-sm text-red-600">Respuesta inválida</p>'; openGroupDetails(); return; }

                            // Expecting { status: 'ok', group: { ... } }
                            const grp = data.group || data;
                            groupDetailsBody.innerHTML = `
                                <div>
                                    <p class="text-sm">ID: <strong>${grp.id ?? ''}</strong></p>
                                    <p class="text-sm">Nombre: <strong>${grp.name ?? ''}</strong></p>
                                    <p class="text-sm">Catequista ID: <strong>${grp.catechist_id ?? grp.CatechistId ?? ''}</strong></p>
                                </div>
                            `;
                            openGroupDetails();
                        }catch(err){
                            console.error('fetch group by id error', err);
                            groupDetailsBody.innerHTML = '<p class="text-sm text-red-600">Error de red</p>'; openGroupDetails();
                        }
                    }

                    // Delegate click for dynamically created buttons (use closest() so clicks on inner elements work)
                    document.addEventListener('click', function(ev){
                        // view-credentials
                        const btnView = ev.target.closest && ev.target.closest('.view-credentials');
                        if(btnView){
                            ev.preventDefault();
                            const id = btnView.getAttribute('data-id');
                            if(id) fetchUserById(id);
                            return;
                        }

                        // delete-user
                        const btnDelete = ev.target.closest && ev.target.closest('.delete-user');
                        if(btnDelete){
                            ev.preventDefault();
                            const id = btnDelete.getAttribute('data-id');
                            if(!id) { alert('Id de usuario inválido'); return; }
                            if(!confirm('¿Eliminar usuario? Esta acción no se puede deshacer.')) return;

                            const url = '/delete-user/'+id;
                            console.log('Deleting user', id, '->', url);

                            // call DELETE
                            (async function(){
                                try{
                                    const resp = await fetch(url, { method: 'DELETE', credentials: 'same-origin', headers: { 'Accept': 'application/json' } });
                                    if(!resp.ok){
                                        const txt = await resp.text().catch(()=>resp.statusText||'Error');
                                        console.error('Delete returned', resp.status, txt);
                                        alert('Error al eliminar: '+resp.status+' '+txt+'\nRevisa que el servidor esté corriendo y que la ruta exista.');
                                        return;
                                    }
                                    const data = await resp.json().catch(()=>null);
                                    console.log('Delete OK', data);
                                    // refresh lists: catechists and scanners
                                    if(typeof fetchCatechists === 'function') fetchCatechists();
                                    if(typeof fetchScanners === 'function') fetchScanners();
                                }catch(err){
                                    console.error('delete user error', err);
                                    alert('Error de red al eliminar usuario: '+err.message);
                                }
                            })();
                            return;
                        }

                        // view-group
                        const btnViewGroup = ev.target.closest && ev.target.closest('.view-group');
                        if(btnViewGroup){
                            ev.preventDefault();
                            const id = btnViewGroup.getAttribute('data-id');
                            if(id) fetchGroupById(id);
                            return;
                        }

                        // edit-group
                        const btnEditGroup = ev.target.closest && ev.target.closest('.edit-group');
                        if(btnEditGroup){
                            ev.preventDefault();
                            const id = btnEditGroup.getAttribute('data-id');
                            const name = btnEditGroup.getAttribute('data-name') || '';
                            const catechist = btnEditGroup.getAttribute('data-catechist') || '';
                            // fill modal
                            const modal = document.getElementById('editGroupModal');
                            const inputId = document.getElementById('editGroupId');
                            const inputName = document.getElementById('editGroupName');
                            const inputCate = document.getElementById('editGroupCatechist');
                            inputId && (inputId.value = id);
                            inputName && (inputName.value = name);
                            inputCate && (inputCate.value = catechist);
                            if(modal){ modal.classList.remove('hidden'); modal.classList.add('flex'); }
                            return;
                        }

                        // delete-group
                        const btnDeleteGroup = ev.target.closest && ev.target.closest('.delete-group');
                        if(btnDeleteGroup){
                            ev.preventDefault();
                            const id = btnDeleteGroup.getAttribute('data-id');
                            if(!id) { alert('Id de grupo inválido'); return; }
                            if(!confirm('¿Eliminar grupo? Esta acción no se puede deshacer.')) return;

                            const url = '/delete-group/'+id;
                            console.log('Deleting group', id, '->', url);
                            (async function(){
                                try{
                                    const resp = await fetch(url, { method: 'DELETE', credentials: 'same-origin', headers: { 'Accept': 'application/json' } });
                                    if(!resp.ok){
                                        const txt = await resp.text().catch(()=>resp.statusText||'Error');
                                        console.error('Delete group returned', resp.status, txt);
                                        alert('Error al eliminar grupo: '+resp.status+' '+txt+'\nRevisa que el servidor esté corriendo y que la ruta exista.');
                                        return;
                                    }
                                    const data = await resp.json().catch(()=>null);
                                    console.log('Delete group OK', data);
                                    if(typeof fetchGroups === 'function') fetchGroups();
                                }catch(err){
                                    console.error('delete group error', err);
                                    alert('Error de red al eliminar grupo: '+err.message);
                                }
                            })();
                            return;
                        }
                    });
                })();
                </script>

                <script>
                (function(){
                    const tabGroups = document.getElementById('tabGroups');
                    const tabUsers = document.getElementById('tabUsers');
                    const tabDB = document.getElementById('tabDB');
                    const groupsSection = document.getElementById('groupsSection');
                    const usersSection = document.getElementById('usersSection');
                    const dbSection = document.getElementById('dbSection');

                    function activate(tab){
                        // clear all
                        [tabGroups, tabUsers, tabDB].forEach(t=>{ if(t) t.classList.remove('bg-white','shadow','-translate-y-0.5'); t && t.setAttribute('aria-selected','false'); });
                        [groupsSection, usersSection, dbSection].forEach(s=>{ if(s) s.classList.add('hidden'); });

                        if(tab === 'groups'){
                            tabGroups && tabGroups.classList.add('bg-white','shadow'); tabGroups && tabGroups.setAttribute('aria-selected','true');
                            groupsSection && groupsSection.classList.remove('hidden');
                            // refresh groups
                            if(typeof fetchGroups === 'function') fetchGroups();
                        } else if(tab === 'users'){
                            tabUsers && tabUsers.classList.add('bg-white','shadow'); tabUsers && tabUsers.setAttribute('aria-selected','true');
                            usersSection && usersSection.classList.remove('hidden');
                            if(typeof fetchCatechists === 'function') fetchCatechists();
                            if(typeof fetchScanners === 'function') fetchScanners();
                        } else {
                            tabDB && tabDB.classList.add('bg-white','shadow'); tabDB && tabDB.setAttribute('aria-selected','true');
                            dbSection && dbSection.classList.remove('hidden');
                        }
                    }

                    tabGroups && tabGroups.addEventListener('click', function(e){ e.preventDefault(); activate('groups'); });
                    tabUsers && tabUsers.addEventListener('click', function(e){ e.preventDefault(); activate('users'); });
                    tabDB && tabDB.addEventListener('click', function(e){ e.preventDefault(); activate('db'); });

                    // default open groups
                    activate('groups');
                })();
                </script>

</main>
{{ end }}