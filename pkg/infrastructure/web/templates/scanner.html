{{ define "content" }}
<nav-component></nav-component>

<main class="container mx-auto px-4 min-h-screen max-w-2xl flex flex-col items-center justify-center gap-6">
  <div class="text-center mb-8">
    <h1 class="text-2xl sm:text-2xl font-medium leading-snug">Escanear C√≥digo QR</h1>
    <p class="text-gray-600 mt-1 text-sm sm:text-base">Escanea el c√≥digo QR del catec√∫meno para registrar su asistencia</p>
  </div>

  <div class="flex flex-col items-center justify-center w-full">
    <div class="w-full bg-white rounded-2xl">
      <div class="bg-white rounded-lg px-6 w-full max-w-md flex flex-col items-center mx-auto min-h-[70vh] justify-center">
        
        <div
          id="preview"
          class="w-75 h-75 sm:w-56 sm:h-56 md:w-48 md:h-48 rounded-3xl bg-gradient-to-br from-blue-500/10 to-blue-500/5 ring-1 ring-blue-500/20 flex items-center justify-center mb-8 relative overflow-hidden transition-all duration-300"
          aria-label="√Årea de escaneo"
        >
          <div id="previewOverlay" class="absolute inset-0 flex items-center justify-center pointer-events-none">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                 stroke-linejoin="round"
                 class="lucide lucide-scan w-35 h-35 sm:w-20 sm:h-20 md:w-16 md:h-16 text-[#1A388B]"
                 aria-hidden="true">
              <path d="M3 7V5a2 2 0 0 1 2-2h2"></path>
              <path d="M17 3h2a2 2 0 0 1 2 2v2"></path>
              <path d="M21 17v2a2 2 0 0 1-2 2h-2"></path>
              <path d="M7 21H5a2 2 0 0 1-2-2v-2"></path>
            </svg>
          </div>
        </div>

        <button
          id="scanButton"
          type="button"
          class="w-full inline-flex items-center justify-center gap-3 py-3 sm:py-2 px-6 text-lg sm:text-base font-medium rounded-xl text-white bg-[#1A388B] hover:opacity-90 transition cursor-pointer disabled:bg-gray-300 disabled:text-gray-600 disabled:cursor-not-allowed disabled:hover:opacity-100"
        >
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
               fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
               stroke-linejoin="round"
               class="w-6 h-6 sm:w-5 sm:h-5 text-white"
               aria-hidden="true">
            <path d="M3 7V5a2 2 0 0 1 2-2h2"></path>
            <path d="M17 3h2a2 2 0 0 1 2 2v2"></path>
            <path d="M21 17v2a2 2 0 0 1-2 2h-2"></path>
            <path d="M7 21H5a2 2 0 0 1-2-2v-2"></path>
          </svg>
          Escanear QR
        </button>

        <p class="text-gray-500 mt-6 text-center text-base sm:text-sm leading-relaxed">
          Coloca el c√≥digo QR dentro del recuadro
        </p>

      </div>
    </div>
  </div>
</main>
<footer-component></footer-component>

<!-- Librer√≠a del esc√°ner -->
<script src="https://unpkg.com/html5-qrcode" defer></script>

<script>
  const preview    = document.getElementById('preview');
  const scanButton = document.getElementById('scanButton');

  let html5QrCode = null;
  let scanning = false;
  let claimedOnce = false;
  let warmupStream = null;

  let lastDecodedText = null;
  let lastScanTime = 0;
  const STABILITY_DELAY = 800;

  // Reset total y seguro
  async function hardReset() {
    if (html5QrCode) {
      try { await html5QrCode.stop(); } catch {}
      try { await html5QrCode.clear(); } catch {}
      html5QrCode = null;
    }
    if (warmupStream) {
      try { warmupStream.getTracks().forEach(t => t.stop()); } catch {}
      warmupStream = null;
    }

    scanning = false;
    claimedOnce = false;

    // UI: bot√≥n
    if (scanButton) {
      scanButton.disabled = false;
      scanButton.textContent = "Escanear QR";
    }

    // UI: overlay visible, video detenido si qued√≥ alguno
    if (preview) {
      const v = preview.querySelector('video');
      if (v && v.srcObject) {
        try { v.srcObject.getTracks().forEach(t => t.stop()); } catch {}
      }
      const overlay = document.getElementById('previewOverlay');
      if (overlay) overlay.style.display = '';
    }
  }

  // Forzar prompt de permisos si no est√°n concedidos ‚Äúpermanentes‚Äù
  async function ensureCameraPermission() {
    warmupStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" } },
      audio: false
    });
    // Cerramos enseguida; html5-qrcode abrir√° su propio stream
    warmupStream.getTracks().forEach(t => t.stop());
    warmupStream = null;
  }

  function extractId(text) {
    // Soporta: /qr/123, /qr/123/claim, ... o solo "123"
    const m = text.match(/(?:^|https?:\/\/[^ ]+)?(?:\/)?qr\/(\d+)(?:\/claim)?(?:[?#].*)?$/i);
    if (m) return parseInt(m[1], 10);
    if (/^\d+$/.test(text)) return parseInt(text, 10);
    return null;
  }

  async function startScanner() {
    if (scanning) return;
    scanning = true;
    claimedOnce = false;

    // 1) Reset PRIMERO para evitar flickers/estados viejos
    await hardReset();

    // 2) UI -> escaneando
    const originalText = scanButton.textContent;
    scanButton.disabled = true;
    scanButton.textContent = "Escaneando...";

    // 3) Oculta overlay actual
    const overlay = document.getElementById('previewOverlay');
    if (overlay) overlay.style.display = 'none';

    // 4) Forzar permiso
    try {
      await ensureCameraPermission();
    } catch (err) {
      console.error("Permiso de c√°mara denegado o fall√≥:", err);
      alert("No se pudo acceder a la c√°mara üì∑\n" + (err?.message || err));
      await hardReset();
      return;
    }

    // 5) Nueva instancia SIEMPRE
    html5QrCode = new Html5Qrcode("preview");

    const config = {
      fps: 10,
      qrbox(viewfinder) {
        const side = Math.floor(Math.min(viewfinder.width, viewfinder.height) * 0.8);
        return { width: side, height: side };
      }
    };

    const onScanSuccess = async (decodedText) => {
      const now = Date.now();

      // 1Ô∏è‚É£ Si es igual al √∫ltimo QR y pas√≥ poco tiempo, ignorar
      if (decodedText === lastDecodedText && now - lastScanTime < STABILITY_DELAY) return;

      // 2Ô∏è‚É£ Registrar intento actual
      lastDecodedText = decodedText;
      lastScanTime = now;

      // 3Ô∏è‚É£ Esperar un peque√±o retardo para confirmar estabilidad (no parpadeo)
      await new Promise(r => setTimeout(r, STABILITY_DELAY));

      // 4Ô∏è‚É£ Si cambi√≥ durante el retardo, abortar
      if (decodedText !== lastDecodedText) return;

      // 5Ô∏è‚É£ Evitar m√∫ltiples claims
      if (claimedOnce) return;
      claimedOnce = true;

      const id = extractId(decodedText);
      if (!id) {
        alert("C√≥digo QR no v√°lido");
        await hardReset();
        return;
      }

      try { await html5QrCode.stop(); } catch {}
      if (navigator.vibrate) navigator.vibrate(60);

      // POST de reclamo (como ya ten√≠as)
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/qr/${id}/claim`;
      const csrf = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
      if (csrf) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'csrf_token';
        input.value = csrf;
        form.appendChild(input);
      }
      document.body.appendChild(form);
      form.submit();
    };


    try {
      // 6) Iniciar esc√°ner
      await html5QrCode.start(
        { facingMode: "environment" },
        config,
        onScanSuccess,
        () => {} // onScanFailure silencioso
      );

      // Ajustes visuales del <video> (iOS inline, cover, radios)
      queueMicrotask(() => {
        const video = preview.querySelector('video');
        if (video) {
          video.setAttribute('playsinline', 'true');
          video.removeAttribute('controls');
          video.style.width = '100%';
          video.style.height = '100%';
          video.style.objectFit = 'cover';
          video.style.borderRadius = getComputedStyle(preview).borderRadius;
        }
      });
    } catch (err) {
      console.error("Error al iniciar el esc√°ner:", err);
      alert("No se pudo iniciar el esc√°ner üì∑\n" + (err?.message || err));
      await hardReset();
      return;
    }

    // 7) Volver a estado ‚Äúlisto‚Äù
    scanButton.disabled = false;
    scanButton.textContent = originalText;
  }

  // Ciclo de vida: al ocultar/abandonar la p√°gina, resetea
  document.addEventListener('visibilitychange', async () => {
    if (document.hidden) await hardReset();
  });

  // Nota: muchos navegadores no esperan async en beforeunload; hazlo s√≠ncrono
  window.addEventListener('beforeunload', () => {
    try { html5QrCode?.stop(); } catch {}
    try { html5QrCode?.clear(); } catch {}
    try { warmupStream?.getTracks().forEach(t => t.stop()); } catch {}
  });

  // Solo el BOT√ìN abre la c√°mara
  scanButton.addEventListener('click', startScanner);
</script>

{{ end }}
