{{ define "content" }}

<main class="container mx-auto px-4 py-8 max-w-2xl">
  <div class="text-center mb-8">
    <h1 class="text-2xl sm:text-2xl font-medium leading-snug">Escanear C칩digo QR</h1>
    <p class="text-gray-600 mt-1 text-sm sm:text-base">Escanea el c칩digo QR del catec칰meno para registrar su asistencia</p>
  </div>


<div class="flex flex-col items-center justify-center w-full">
  <div class="w-full bg-white rounded-2xl">
    <div class="bg-white rounded-lg px-6 w-full max-w-md flex flex-col items-center mx-auto min-h-[70vh] justify-center">
      
      <div
        id="preview"
        class="w-64 h-64 sm:w-56 sm:h-56 md:w-48 md:h-48 rounded-3xl bg-gradient-to-br from-blue-500/10 to-blue-500/5 ring-1 ring-blue-500/20 flex items-center justify-center mb-8 relative overflow-hidden cursor-pointer transition-all duration-300"
        aria-label="츼rea de escaneo"
      >
        <div id="previewOverlay" class="absolute inset-0 flex items-center justify-center pointer-events-none">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
               fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
               stroke-linejoin="round"
               class="lucide lucide-scan w-24 h-24 sm:w-20 sm:h-20 md:w-16 md:h-16 text-[#1A388B]"
               aria-hidden="true">
            <path d="M3 7V5a2 2 0 0 1 2-2h2"></path>
            <path d="M17 3h2a2 2 0 0 1 2 2v2"></path>
            <path d="M21 17v2a2 2 0 0 1-2 2h-2"></path>
            <path d="M7 21H5a2 2 0 0 1-2-2v-2"></path>
          </svg>
        </div>
      </div>

      <button
        id="scanButton"
        type="button"
        class="w-full inline-flex items-center justify-center gap-3 py-3 sm:py-2 px-6 text-lg sm:text-base font-medium rounded-xl text-white bg-[#1A388B] hover:opacity-90 transition cursor-pointer disabled:bg-gray-300 disabled:text-gray-600 disabled:cursor-not-allowed disabled:hover:opacity-100"
      >
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
             fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
             stroke-linejoin="round"
             class="w-6 h-6 sm:w-5 sm:h-5 text-white"
             aria-hidden="true">
          <path d="M3 7V5a2 2 0 0 1 2-2h2"></path>
          <path d="M17 3h2a2 2 0 0 1 2 2v2"></path>
          <path d="M21 17v2a2 2 0 0 1-2 2h-2"></path>
          <path d="M7 21H5a2 2 0 0 1-2-2v-2"></path>
        </svg>
        Escanear QR
      </button>

          <p class="text-gray-500 mt-6 text-center text-base sm:text-sm leading-relaxed">
            Coloca el c칩digo QR dentro del recuadro
          </p>

        </div>
      </div>
    </div>


  </div>
</main>

<!-- Librer칤a del esc치ner -->
<script src="https://unpkg.com/html5-qrcode" defer></script>

<script>
  const preview    = document.getElementById('preview');
  const overlay    = document.getElementById('previewOverlay');
  const scanButton = document.getElementById('scanButton');

  let html5QrCode = null;
  let scanning    = false;
  let claimedOnce = false; 

  document.addEventListener('visibilitychange', async () => {
    if (document.hidden && html5QrCode) {
      try { await html5QrCode.stop(); } catch {}
      try { await html5QrCode.clear(); } catch {}
      if (overlay) overlay.style.display = '';
      scanning = false;
      scanButton.disabled = false;
    }
  });

  async function startScanner() {
    if (scanning) return;
    scanning = true;
    claimedOnce = false;

    if (overlay) overlay.style.display = 'none';
    scanButton.disabled = true;
    const originalText = scanButton.textContent;
    scanButton.textContent = "Escaneando...";

    function resetUI() {
      scanning = false;
      scanButton.disabled = false;
      scanButton.textContent = originalText;
      if (overlay) overlay.style.display = '';
      try { html5QrCode?.clear(); } catch {}
    }

    function extractId(text) {
      if (/^\d+$/.test(text)) return parseInt(text, 10); 
      const m  = text.match(/\/qr\/(\d+)(?:\/claim)?(?:[?#].*)?$/i);
      if (m) return parseInt(m[1], 10);
      const m2 = text.match(/qr\/(\d+)/i); 
      if (m2) return parseInt(m2[1], 10);
      return null;
    }

    async function onScanSuccess(decodedText) {
      if (claimedOnce) return; 

      const id = extractId(decodedText);
      if (!id) {
        alert("C칩digo QR no v치lido");
        try { await html5QrCode.stop(); } catch {}
        resetUI();
        return;
      }

      claimedOnce = true;

      try { await html5QrCode.stop(); } catch {}

      if (navigator.vibrate) navigator.vibrate(50);

      const form = document.createElement('form');
      form.method = 'POST';
      form.action = `/qr/${id}/claim`;

      const csrf = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
      if (csrf) {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'csrf_token'; 
        input.value = csrf;
        form.appendChild(input);
      }

      document.body.appendChild(form);
      form.submit(); 
    }

    try {
      if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("preview");
      } else {
        try { await html5QrCode.clear(); } catch {}
      }

      const config = {
        fps: 10,
        qrbox(viewfinder) {
          const side = Math.floor(Math.min(viewfinder.width, viewfinder.height) * 0.8);
          return { width: side, height: side };
        }
      };

      await html5QrCode.start(
        { facingMode: "environment" },
        config,
        onScanSuccess,
        () => {} 
      );

      queueMicrotask(() => {
        const video = preview.querySelector('video');
        if (video) {
          video.setAttribute('playsinline', 'true');
          video.removeAttribute('controls');
          video.style.width = '100%';
          video.style.height = '100%';
          video.style.objectFit = 'cover';
          video.style.borderRadius = getComputedStyle(preview).borderRadius;
        }
      });

    } catch (err) {
      console.error("Error al abrir c치mara:", err);
      alert("No se pudo acceder a la c치mara 游닝\n" + (err?.message || err));
      try { await html5QrCode?.stop(); } catch {}
      resetUI();
    }
  }

  scanButton.addEventListener('click', startScanner);
  preview.addEventListener('click', startScanner);
</script>

{{ end }}
